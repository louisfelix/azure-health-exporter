# azure-health-exporter

**Warning, this exporter is still a work in progress**

Prometheus exporter exposing Azure Health status as metrics

This exporter does not export metrics from Azure Monitor API, use [azure_metrics_exporter](https://github.com/RobustPerception/azure_metrics_exporter) for that.

## Getting Started

### Azure account requirements

This exporter call Azure API from an existing subscription with these requirements:

* An application must be registered (e.g., Azure Active Directory -> App registrations -> New application registration)

### Prerequisites

To run this project, you will need a [working Go environment](https://golang.org/doc/install).

### Installing

```bash
go get -u github.com/FXinnovation/azure-health-exporter
```

## Building

Build the sources with

```bash
make build
```

## Run the binary

```bash
./azure-health-exporter
```

The exporter expects these environment variables to configure the Azure API
connection.

Environment Variable | Description
---------------------| -----------
AZURE_SUBSCRIPTION_ID | Found under properties in the Azure portal for your application/service
AZURE_TENANT_ID | Found under `Azure Active Directory > Properties` and listed as `Directory ID`
AZURE_CLIENT_ID | Also listed as `Application Id`, is obtained by registering an application under 'Azure Active Directory'
AZURE_CLIENT_SECRET | Is generated by selecting your application/service under Azure Active Directory, selecting 'keys', and generating a new key

By default, the exporter optional config file is expected in `config/config.yml`.

Use -h flag to list available options.

## Testing

### Running unit tests

```bash
make test
```

## Configuration

No configuration is supported yet in `config/config.yml` (**WIP**)

## Docker image

You can build a docker image using:

```bash
make docker
```

The resulting image is named `fxinnovation/azure-health-exporter:<git-branch>`.
It exposes port 9613 and expects an optional config in `/opt/azure-health-exporter/config.yml`.
To configure it, you must pass the envionment variable, and you can bind-mount a config from your host:

```bash
docker run -p 9613:9613 -v /path/on/host/config/config.yml:/opt/azure-health-exporter/config/config.yml -e AZURE_SUBSCRIPTION_ID="my_subscription_id" -e AZURE_TENANT_ID="my_tenant_id" -e AZURE_CLIENT_ID="my_client_id" -e AZURE_CLIENT_SECRET="my_client_secret" fxinnovation/azure-health-exporter:<git-branch>

## Exposed metrics

Metric | Description
------ | -----------
resource_health_availability_up | Resource health availability that relies on signals from different Azure services to assess whether a resource is healthy

## Contributing

Refer to [CONTRIBUTING.md](https://github.com/FXinnovation/azure-health-exporter/blob/master/CONTRIBUTING.md).

## License

Apache License 2.0, see [LICENSE](https://github.com/FXinnovation/azure-health-exporter/blob/master/LICENSE).
